name: Auto Code Review (PR)


on:
pull_request:
types: [opened, synchronize, reopened]


permissions:
contents: read
pull-requests: write
checks: write


jobs:
run-code-review:
runs-on: ubuntu-latest
steps:
- name: Checkout
uses: actions/checkout@v4


- name: Set up Python
uses: actions/setup-python@v4
with:
python-version: '3.10'


- name: Install dependencies
run: |
python -m pip install --upgrade pip
pip install requests google-auth google-auth-oauthlib


- name: Fetch PR diff
id: fetch_diff
run: |
PR_NUM=${{ github.event.pull_request.number }}
OWNER=${{ github.repository_owner }}
REPO=${{ github.event.repository.name }}
curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
"https://api.github.com/repos/$OWNER/$REPO/pulls/$PR_NUM" \
| jq -r '.diff_url' > diff_url.txt
DIFF=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "$(cat diff_url.txt)")
echo "DIFF<<'DIFF'" >> diff.txt
echo "$DIFF" >> diff.txt
echo "DIFF" >> diff.txt
echo "diff_path=diff.txt" >> $GITHUB_OUTPUT


- name: Call review script
env:
VERTEX_PROJECT: ${{ secrets.GCP_PROJECT }}
VERTEX_ENDPOINT: ${{ secrets.VERTEX_ENDPOINT }}
GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GCP_SA_KEY }}
GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
run: |
python .github/scripts/review_pr.py --diff-file diff.txt \
--endpoint "$VERTEX_ENDPOINT" --project "$VERTEX_PROJECT"
